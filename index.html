<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çƒŸå°å››ä¸­22çº§å›å¿†å½• | é’æ˜¥æ°¸ä¸æ•£åœº</title>
    <!-- ç¬¬ä¸€æ­¥ï¼šæ·»åŠ Supabaseå®¢æˆ·ç«¯åº“ -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "å¾®è½¯é›…é»‘", sans-serif;
        }
        body {
            background-color: #f5f5f5;
            padding: 20px;
            line-height: 1.8;
        }
        /* å®åå¼¹çª— */
        .auth-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        .auth-form {
            background: white;
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 400px;
            text-align: center;
        }
        .auth-form h2 {
            color: #ff0000;
            margin-bottom: 20px;
        }
        .auth-form input {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
        }
        .auth-form button {
            width: 100%;
            padding: 10px;
            background: #ff0000;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
        }
        /* é¡¶éƒ¨çŠ¶æ€åŒº */
        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }
        .current-user {
            color: #666;
        }
        .current-user span {
            color: #ff0000;
            font-weight: bold;
        }
        .admin-login {
            display: flex;
            gap: 5px;
        }
        .admin-login input {
            padding: 4px 8px;
            border: 1px solid #ddd;
            border-radius: 3px;
            font-size: 14px;
        }
        .admin-login button {
            padding: 4px 8px;
            border: none;
            border-radius: 3px;
            background: #ff0000;
            color: white;
            cursor: pointer;
            font-size: 14px;
        }
        /* æ ‡ç­¾é¡µæ ·å¼ */
        .tab-container {
            margin-bottom: 20px;
        }
        .tabs {
            display: flex;
            border-bottom: 2px solid #ddd;
        }
        .tab {
            padding: 10px 20px;
            background: #eee;
            border: none;
            border-radius: 8px 8px 0 0;
            cursor: pointer;
            font-size: 16px;
            margin-right: 5px;
        }
        .tab.active {
            background: #ff0000;
            color: white;
        }
        .tab-content {
            display: none;
            padding: 20px 0;
        }
        .tab-content.active {
            display: block;
        }
        /* é€šç”¨é¡µé¢æ ·å¼ */
        h1 {
            text-align: center;
            margin: 20px 0;
            color: #333;
            font-size: 24px;
        }
        h4 {
            text-align: center;
            color: #666;
            margin: 10px 0;
        }
        h3 {
            text-align: center;
            margin: 15px 0;
            font-size: 18px;
        }
        .warning {
            background: #fff3cd;
            padding: 12px;
            border-radius: 8px;
            margin: 15px 0;
            font-weight: bold;
            color: #856404;
            text-align: center;
        }
        .rule {
            background: #e9f5ff;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }
        /* ä¸»å†…å®¹åŒº - è¯é¢˜æ ·å¼ */
        .topic {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        .topic h2 {
            color: #ff0000;
            margin-bottom: 15px;
            font-size: 19px;
            border-left: 4px solid #ff0000;
            padding-left: 10px;
        }
        /* è¯„è®ºæ ·å¼ */
        .comment-group {
            margin: 15px 0;
        }
        .collapse-btn {
            padding: 4px 8px;
            border: none;
            border-radius: 4px;
            background: #f0f0f0;
            color: #333;
            cursor: pointer;
            font-size: 13px;
            margin-bottom: 8px;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        .comment-container {
            margin: 10px 0;
        }
        .comment {
            padding: 10px;
            border-radius: 6px;
            background: #f9f9f9;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }
        /* å›å¤è¯„è®ºçš„ç‰¹æ®Šæ ·å¼ - æ”¹ä¸ºç‹¬ç«‹è¯„è®ºä½†æœ‰æ ‡è®° */
        .reply-comment {
            background: #f0f8ff;
            border-left: 3px solid #44aaff;
        }
        .comment-content {
            flex: 1;
        }
        .comment-author {
            color: #ff0000;
            font-weight: bold;
            margin-right: 8px;
        }
        .reply-to {
            font-size: 12px;
            color: #0066cc;
            margin-bottom: 5px;
            display: block;
            font-style: italic;
        }
        .comment-time {
            font-size: 12px;
            color: #999;
            margin-top: 3px;
            display: block;
        }
        .comment-actions {
            display: flex;
            gap: 8px;
            margin-left: 10px;
            margin-top: 2px;
        }
        .action-btn {
            padding: 3px 8px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            color: white;
        }
        .reply-btn {
            background: #99cc00;
        }
        .edit-btn {
            background: #44aaff;
        }
        .delete-btn {
            background: #ff6666;
        }
        .like-btn {
            background: #f5f5f5;
            color: #666;
        }
        .like-btn.active {
            background: linear-gradient(135deg, #ff4444, #cc0000);
            color: white;
        }
        .like-btn::before {
            content: "â¤ï¸";
            margin-right: 3px;
        }
        /* å›å¤è¾“å…¥æ¡† */
        .reply-input-container {
            margin: 8px 0 12px;
            display: flex;
            gap: 10px;
        }
        .reply-input {
            flex: 1;
            padding: 6px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 13px;
        }
        .reply-submit {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            background: #ff0000;
            color: white;
            font-size: 13px;
            cursor: pointer;
        }
        /* ä¸»è¯„è®ºè¾“å…¥æ¡† */
        .comment-input-container {
            margin-top: 20px;
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .comment-input {
            flex: 1;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }
        .submit-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            background: #ff0000;
            color: white;
            font-size: 14px;
            cursor: pointer;
        }
        /* è‡ªç”±å‘è¨€åŒº */
        .final-topic {
            background: #fff8e1;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        .final-topic h2 {
            color: #ff0000;
            text-align: center;
            margin-bottom: 15px;
        }
        /* åª’ä½“ä¸“åŒºæ ·å¼ */
        .upload-area {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        .upload-area h2 {
            color: #ff0000;
            font-size: 19px;
            margin-bottom: 15px;
            border-left: 4px solid #ff0000;
            padding-left: 10px;
        }
        .upload-form {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
        }
        .upload-input {
            flex: 1;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }
        .file-input {
            padding: 6px;
            border: 1px solid #ddd;
            border-radius: 6px;
            cursor: pointer;
        }
        .upload-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            background: #0066cc;
            color: white;
            font-size: 14px;
            cursor: pointer;
        }
        /* ä¸Šä¼ è¿›åº¦æ¡ */
        .progress-container {
            width: 100%;
            height: 8px;
            background: #eee;
            border-radius: 4px;
            margin-top: 10px;
            overflow: hidden;
            display: none;
        }
        .progress-bar {
            height: 100%;
            background: #0066cc;
            width: 0%;
            transition: width 0.3s ease;
        }
        .upload-tip {
            color: #666;
            font-size: 14px;
            margin-top: 5px;
        }
        .media-list {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-top: 20px;
        }
        .media-card {
            width: calc(33.333% - 14px);
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            cursor: pointer;
        }
        .media-container {
            width: 100%;
            height: 200px;
            position: relative;
        }
        .media-container img, .media-container video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .video-play-btn {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 40px;
            height: 40px;
            background: rgba(0,0,0,0.6);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            cursor: pointer;
        }
        .media-info {
            padding: 15px;
        }
        .media-author {
            color: #ff0000;
            font-weight: bold;
            margin-right: 8px;
        }
        .media-content {
            margin: 10px 0;
            line-height: 1.5;
        }
        .media-time {
            font-size: 12px;
            color: #999;
            margin-bottom: 10px;
            display: block;
        }
        .media-actions {
            text-align: right;
        }
        /* åª’ä½“æ”¾å¤§é¢„è§ˆå±‚ */
        .media-preview {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 9999;
            display: none;
            justify-content: center;
            align-items: center;
            padding: 40px;
        }
        .preview-content {
            position: relative;
            max-width: 90%;
            max-height: 80%;
        }
        .preview-img {
            max-width: 100%;
            max-height: 80vh;
            cursor: move;
            transition: transform 0.2s ease;
            transform-origin: center;
        }
        .preview-video {
            width: 100%;
            max-height: 80vh;
        }
        /* é¢„è§ˆæ§åˆ¶æ  */
        .preview-controls {
            position: absolute;
            bottom: -40px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 15px;
            color: white;
        }
        .preview-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            border-radius: 4px;
            padding: 6px 12px;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .close-preview {
            position: absolute;
            top: -30px;
            right: 0;
            background: transparent;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 5px;
        }
        /* å›¾ç‰‡ç¼©æ”¾æ§åˆ¶ */
        .zoom-controls {
            position: absolute;
            top: 0;
            left: 0;
            display: flex;
            gap: 10px;
            background: rgba(0,0,0,0.5);
            padding: 8px;
            border-radius: 0 0 8px 0;
        }
        .zoom-btn {
            width: 30px;
            height: 30px;
            border-radius: 4px;
            border: none;
            background: rgba(255,255,255,0.3);
            color: white;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        /* å“åº”å¼é€‚é… */
        @media (max-width: 768px) {
            h1 {
                font-size: 22px;
            }
            .topic, .final-topic, .upload-area {
                padding: 15px;
            }
            .comment-input-container, .upload-form, .reply-input-container {
                flex-wrap: wrap;
                align-items: stretch;
            }
            .submit-btn, .upload-btn, .reply-submit {
                width: 100%;
                margin-top: 5px;
            }
            .comment, .tabs {
                flex-wrap: wrap;
            }
            .comment-actions {
                margin-left: 0;
                margin-top: 8px;
                width: 100%;
                justify-content: flex-end;
            }
            .media-card {
                width: calc(50% - 10px);
            }
            .media-container {
                height: 150px;
            }
            .tab {
                padding: 8px 12px;
                font-size: 14px;
            }
            .preview-controls {
                flex-wrap: wrap;
                justify-content: center;
                bottom: -60px;
            }
        }
    </style>
</head>
<body>
    <!-- å®åå¼¹çª— -->
    <div class="auth-modal" id="auth-modal" style="display:none">
        <div class="auth-form">
            <h2>è¯·è¾“å…¥ä½ çš„åå­—</h2>
            <input type="text" id="user-name" placeholder="ä¾‹å¦‚ï¼šå¼ ä¸‰" required>
            <button onclick="confirmAuth()">ç¡®è®¤è¿›å…¥</button>
        </div>
    </div>
    <!-- é¡¶éƒ¨çŠ¶æ€æ  -->
    <div class="top-bar">
        <div class="current-user" id="current-user"></div>
        <div class="admin-login">
            <input type="password" id="admin-pwd" placeholder="ç®¡ç†å‘˜å¯†ç ">
            <button onclick="adminLogin()">ç®¡ç†å‘˜ç™»å½•</button>
        </div>
    </div>
    <h1>çƒŸå°å››ä¸­2022çº§10ç­å›å¿†å½•</h1>
    <h4>é’æ˜¥æ°¸ä¸æ•£åœº Â· æˆ‘ä»¬çš„æ•…äº‹ä»è¿™é‡Œå¼€å§‹</h4>
    <!-- æ ‡ç­¾é¡µå®¹å™¨ -->
    <div class="tab-container">
        <div class="tabs">
            <button class="tab active" data-target="tab-memories">é’æ˜¥è®°å¿†</button>
            <button class="tab" data-target="tab-media">åª’ä½“ä¸“åŒº</button>
            <button class="tab" data-target="tab-free">è‡ªç”±å‘è¨€</button>
        </div>
        <!-- é’æ˜¥è®°å¿†æ ‡ç­¾é¡µ -->
        <div id="tab-memories" class="tab-content active">
            <div class="warning">
                æ¸©é¦¨æç¤ºï¼šè¯·æ–‡æ˜å‘è¨€ï¼Œå°Šé‡ä»–äººï¼Œå…±åŒç»´æŠ¤ç¾å¥½çš„å›å¿†ç©ºé—´ã€‚
            </div>
            <!-- è¯é¢˜1 -->
            <div class="topic">
                <h2>è¯é¢˜1ï¼šè¿˜è®°å¾—ç¬¬ä¸€æ¬¡è¸è¿›å››ä¸­æ ¡é—¨çš„æƒ…æ™¯å—ï¼Ÿ</h2>
                <div class="rule">
                    <p>ğŸ“ åˆ†äº«ä½ çš„å…¥å­¦ç¬¬ä¸€å°è±¡ï¼Œé‚£æ—¶çš„ä½ æ˜¯ä»€ä¹ˆå¿ƒæƒ…ï¼Ÿ</p>
                </div>
                <div id="comment-list-1"></div>
                <div class="comment-input-container">
                    <input type="text" id="comment-input-1" class="comment-input" placeholder="å†™ä¸‹ä½ çš„å›å¿†...">
                    <button class="submit-btn" data-topic="1" onclick="submitComment(1)">æäº¤</button>
                </div>
            </div>
            <!-- è¯é¢˜2 -->
            <div class="topic">
                <h2>è¯é¢˜2ï¼šæœ€éš¾å¿˜çš„è€å¸ˆæ˜¯è°ï¼Ÿä¸ºä»€ä¹ˆï¼Ÿ</h2>
                <div class="rule">
                    <p>ğŸ‘¨â€ğŸ« åˆ†äº«è€å¸ˆä»¬çš„ç»å…¸è¯­å½•æˆ–æ„Ÿäººç¬é—´</p>
                </div>
                <div id="comment-list-2"></div>
                <div class="comment-input-container">
                    <input type="text" id="comment-input-2" class="comment-input" placeholder="åˆ†äº«ä½ çš„æ•…äº‹...">
                    <button class="submit-btn" data-topic="2" onclick="submitComment(2)">æäº¤</button>
                </div>
            </div>
            <!-- è¯é¢˜3 -->
            <div class="topic">
                <h2>è¯é¢˜3ï¼šæ ¡å›­é‡Œæœ€å–œæ¬¢çš„åœ°æ–¹æ˜¯å“ªé‡Œï¼Ÿ</h2>
                <div class="rule">
                    <p>ğŸ« æ“åœºã€å›¾ä¹¦é¦†ã€å°èŠ±å›­è¿˜æ˜¯æ•™å®¤ï¼Ÿè¯´è¯´åŸå› </p>
                </div>
                <div id="comment-list-3"></div>
                <div class="comment-input-container">
                    <input type="text" id="comment-input-3" class="comment-input" placeholder="åˆ†äº«ä½ çš„æ•…äº‹...">
                    <button class="submit-btn" data-topic="3" onclick="submitComment(3)">æäº¤</button>
                </div>
            </div>
            <!-- è¯é¢˜4 -->
            <div class="topic">
                <h2>è¯é¢˜4ï¼šæœ€éš¾å¿˜çš„ç­çº§æ´»åŠ¨æˆ–é›†ä½“å›å¿†</h2>
                <div class="rule">
                    <p>ğŸ‰ è¿åŠ¨ä¼šã€æ–‡è‰ºæ±‡æ¼”ã€æ˜¥æ¸¸è¿˜æ˜¯ç­ä¼šï¼Ÿ</p>
                </div>
                <div id="comment-list-4"></div>
                <div class="comment-input-container">
                    <input type="text" id="comment-input-4" class="comment-input" placeholder="åˆ†äº«ä½ çš„æ•…äº‹...">
                    <button class="submit-btn" data-topic="4" onclick="submitComment(4)">æäº¤</button>
                </div>
            </div>
            <!-- è¯é¢˜6 -->
            <div class="topic">
                <h2>è¯é¢˜6ï¼šæœ€è¦å¥½çš„æœ‹å‹å’Œä½ ä»¬çš„æ•…äº‹</h2>
                <div class="rule">
                    <p>ğŸ‘« åˆ†äº«ä½ ä»¬çš„å‹è°Šæ•…äº‹å’Œéš¾å¿˜ç¬é—´</p>
                </div>
                <div id="comment-list-6"></div>
                <div class="comment-input-container">
                    <input type="text" id="comment-input-6" class="comment-input" placeholder="åˆ†äº«ä½ çš„æ•…äº‹...">
                    <button class="submit-btn" data-topic="6" onclick="submitComment(6)">æäº¤</button>
                </div>
            </div>
            <!-- è¯é¢˜8 -->
            <div class="topic">
                <h2>è¯é¢˜8ï¼šæœ€éš¾å¿˜çš„ä¸€å ‚è¯¾</h2>
                <div class="rule">
                    <p>ğŸ“š å“ªå ‚è¯¾è®©ä½ å°è±¡æ·±åˆ»ï¼Ÿä¸ºä»€ä¹ˆï¼Ÿ</p>
                </div>
                <div id="comment-list-8"></div>
                <div class="comment-input-container">
                    <input type="text" id="comment-input-8" class="comment-input" placeholder="åˆ†äº«ä½ çš„æ•…äº‹...">
                    <button class="submit-btn" data-topic="8" onclick="submitComment(8)">æäº¤</button>
                </div>
            </div>
            <!-- è¯é¢˜9 -->
            <div class="topic">
                <h2>è¯é¢˜9ï¼šé£Ÿå ‚ç¾é£Ÿoré»‘æš—æ–™ç†ï¼Ÿ</h2>
                <div class="rule">
                    <p>ğŸš åˆ†äº«ä½ å¯¹å››ä¸­é£Ÿå ‚çš„å‘³è•¾è®°å¿†</p>
                </div>
                <div id="comment-list-9"></div>
                <div class="comment-input-container">
                    <input type="text" id="comment-input-9" class="comment-input" placeholder="åˆ†äº«ä½ çš„æ•…äº‹...">
                    <button class="submit-btn" data-topic="9" onclick="submitComment(9)">æäº¤</button>
                </div>
            </div>
            <!-- è¯é¢˜10 -->
            <div class="topic">
                <h2>è¯é¢˜10ï¼šæœ€å°´å°¬æˆ–æœ€æç¬‘çš„æ ¡å›­ç¬é—´</h2>
                <div class="rule">
                    <p>ğŸ˜‚ åˆ†äº«é‚£äº›è®©ä½ ç¬‘å‡ºçœ¼æ³ªçš„ç¬é—´</p>
                </div>
                <div id="comment-list-10"></div>
                <div class="comment-input-container">
                    <input type="text" id="comment-input-10" class="comment-input" placeholder="åˆ†äº«ä½ çš„æ•…äº‹...">
                    <button class="submit-btn" data-topic="10" onclick="submitComment(10)">æäº¤</button>
                </div>
            </div>
            <!-- è¯é¢˜11 -->
            <div class="topic">
                <h2>è¯é¢˜11ï¼šç»™å­¦å¼Ÿå­¦å¦¹çš„ä¸€å¥è¯å»ºè®®</h2>
                <div class="rule">
                    <p>ğŸ’¡ ç”¨ä½ çš„ç»éªŒä¸ºåæ¥è€…ç‚¹äº®å‰è¡Œçš„è·¯</p>
                </div>
                <div id="comment-list-11"></div>
                <div class="comment-input-container">
                    <input type="text" id="comment-input-11" class="comment-input" placeholder="åˆ†äº«ä½ çš„å»ºè®®...">
                    <button class="submit-btn" data-topic="11" onclick="submitComment(11)">æäº¤</button>
                </div>
            </div>
            <!-- è¯é¢˜12 -->
            <div class="topic">
                <h2>è¯é¢˜12ï¼šå¦‚æœé‡å›é«˜ä¸­ï¼Œä½ æœ€æƒ³æ”¹å˜ä»€ä¹ˆï¼Ÿ</h2>
                <div class="rule">
                    <p>ğŸ•°ï¸ åˆ†äº«ä½ çš„é—æ†¾æˆ–æœªå®Œæˆçš„æ¢¦æƒ³</p>
                </div>
                <div id="comment-list-12"></div>
                <div class="comment-input-container">
                    <input type="text" id="comment-input-12" class="comment-input" placeholder="åˆ†äº«ä½ çš„æƒ³æ³•...">
                    <button class="submit-btn" data-topic="12" onclick="submitComment(12)">æäº¤</button>
                </div>
            </div>
            <!-- è¯é¢˜13 -->
            <div class="topic">
                <h2>è¯é¢˜13ï¼šæ¯•ä¸šæ—¶çš„æ„Ÿå—å’Œæƒ³å¯¹åŒå­¦è¯´çš„è¯</h2>
                <div class="rule">
                    <p>ğŸ“ åˆ†äº«æ¯•ä¸šæ—¶çš„å¿ƒæƒ…å’Œæƒ³å¯¹å¤§å®¶è¯´çš„è¯</p>
                </div>
                <div id="comment-list-13"></div>
                <div class="comment-input-container">
                    <input type="text" id="comment-input-13" class="comment-input" placeholder="åˆ†äº«ä½ çš„æ„Ÿå—...">
                    <button class="submit-btn" data-topic="13" onclick="submitComment(13)">æäº¤</button>
                </div>
            </div>
        </div>
        <!-- åª’ä½“ä¸“åŒºæ ‡ç­¾é¡µ -->
        <div id="tab-media" class="tab-content">
            <div class="warning">
                æ”¯æŒä¸Šä¼ å›¾ç‰‡å’Œè§†é¢‘ï¼Œä¸å¤§å®¶åˆ†äº«ç¾å¥½ç¬é—´ï¼ˆå•æ–‡ä»¶ä¸è¶…è¿‡10MBï¼‰
            </div>
            <div class="upload-area">
                <h2>ä¸Šä¼ å›¾ç‰‡æˆ–è§†é¢‘</h2>
                <div class="upload-form">
                    <input type="text" id="media-content" class="upload-input" placeholder="è¯´ç‚¹ä»€ä¹ˆ...">
                    <input type="file" id="media-file" class="file-input" accept="image/*,video/*">
                    <button class="upload-btn" onclick="uploadMedia()">ä¸Šä¼ å›¾æ–‡/è§†é¢‘</button>
                </div>
                <div class="progress-container" id="progress-container">
                    <div class="progress-bar" id="upload-progress"></div>
                </div>
                <div class="upload-tip">æ”¯æŒ JPGã€PNG å›¾ç‰‡å’Œ MP4ã€WEBM è§†é¢‘æ ¼å¼</div>
            </div>
            <h3>ğŸ“¸ ç­çº§å›å¿†ç›¸å†Œ</h3>
            <div class="media-list" id="media-list"></div>
        </div>
        <!-- è‡ªç”±å‘è¨€æ ‡ç­¾é¡µ -->
        <div id="tab-free" class="tab-content">
            <div class="final-topic">
                <h2>ğŸ’¬ è‡ªç”±å‘è¨€åŒº</h2>
                <div class="rule">
                    <p>âœ¨ ä»»ä½•æƒ³è¯´çš„è¯ã€æƒ³åˆ†äº«çš„æ•…äº‹ï¼Œéƒ½å¯ä»¥åœ¨è¿™é‡Œç•…æ‰€æ¬²è¨€</p>
                    <p>ğŸ’Œ ç»™è€åŒå­¦çš„ç•™è¨€ã€è¿‘å†µåˆ†äº«ã€æœªæ¥å±•æœ›...</p>
                </div>
                <div id="comment-list-free"></div>
                <div class="comment-input-container">
                    <input type="text" id="comment-input-free" class="comment-input" placeholder="ç•…æ‰€æ¬²è¨€...">
                    <button class="submit-btn" data-topic="free" onclick="submitComment('free')">æäº¤</button>
                </div>
            </div>
        </div>
    </div>
    <!-- åª’ä½“é¢„è§ˆå±‚ -->
    <div class="media-preview" id="media-preview">
        <button class="close-preview" onclick="closeMediaPreview()">Ã—</button>
        <div class="preview-content" id="preview-content"></div>
        <div class="preview-controls">
            <button class="preview-btn" onclick="downloadMedia()">ğŸ“¥ ä¸‹è½½</button>
        </div>
        <div class="zoom-controls" id="zoom-controls" style="display:none">
            <button class="zoom-btn" onclick="zoomImg(-0.1)">-</button>
            <button class="zoom-btn" onclick="zoomImg(0.1)">+</button>
            <button class="zoom-btn" onclick="resetImgZoom()">âŸ³</button>
        </div>
    </div>
    <script>
        // å…¨å±€çŠ¶æ€
        let userName = localStorage.getItem('user_name');
        // ç¬¬äºŒæ­¥ï¼šæ·»åŠ Supabaseåˆå§‹åŒ–ä»£ç 
        // Supabaseé…ç½® - è¯·æ›¿æ¢ä¸ºä½ çš„å®é™…URLå’Œå¯†é’¥
        const SUPABASE_URL = 'æ‚¨å¤åˆ¶çš„Project URL';
        const SUPABASE_KEY = 'æ‚¨å¤åˆ¶çš„anon publicå¯†é’¥';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        let isAdmin = false;
        const ADMIN_PWD = "admin123";
        const COMMENT_KEY = "yishui22_comments";
        const MEDIA_KEY = "yishui22_media";
        let editMediaId = '';
        // åª’ä½“é¢„è§ˆçŠ¶æ€
        let currentPreviewMedia = null;
        let imgScale = 1;
        let isDragging = false;
        let startX = 0, startY = 0, imgX = 0, imgY = 0;
        let currentReplyId = '';
        // é¡µé¢åŠ è½½åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            try {
                if (!userName) {
                    showAuthModal();
                } else {
                    initPage();
                }
            } catch (err) {
                console.error('åˆå§‹åŒ–å¤±è´¥ï¼š', err);
                alert('é¡µé¢åŠ è½½å¼‚å¸¸ï¼Œè¯·åˆ·æ–°é‡è¯•');
            }
        });
        // æ˜¾ç¤ºå®åå¼¹çª—
        function showAuthModal() {
            try {
                const modal = document.getElementById('auth-modal');
                if (modal) {
                    modal.style.display = 'flex';
                    
                    // ç»‘å®šå›è½¦äº‹ä»¶
                    const nameInput = document.getElementById('user-name');
                    if (nameInput) {
                        nameInput.focus();
                        nameInput.addEventListener('keydown', function(e) {
                            if (e.key === 'Enter') {
                                confirmAuth();
                            }
                        });
                    }
                }
            } catch (err) {
                console.error('æ˜¾ç¤ºå®åå¼¹çª—å¤±è´¥ï¼š', err);
            }
        }
        // ç¡®è®¤å®å
        function confirmAuth() {
            try {
                const nameInput = document.getElementById('user-name');
                if (!nameInput) throw new Error('æœªæ‰¾åˆ°åå­—è¾“å…¥æ¡†');
                
                const name = nameInput.value.trim();
                if (!name) {
                    alert('è¯·è¾“å…¥æœ‰æ•ˆçš„åå­—ï¼');
                    return;
                }
                
                userName = name;
                localStorage.setItem('user_name', userName);
                
                const modal = document.getElementById('auth-modal');
                if (modal) modal.style.display = 'none';
                
                initPage();
            } catch (err) {
                console.error('å®åç¡®è®¤å¤±è´¥ï¼š', err);
                alert('æ“ä½œå¼‚å¸¸ï¼Œè¯·é‡è¯•');
            }
        }
        // åˆå§‹åŒ–é¡µé¢
        function initPage() {
            try {
                // æ˜¾ç¤ºå½“å‰ç”¨æˆ·
                const currentUserEl = document.getElementById('current-user');
                if (currentUserEl) {
                    currentUserEl.innerHTML = `å½“å‰ç™»å½•ï¼š<span>${userName}</span>`;
                }
                
                // åˆå§‹åŒ–æ ‡ç­¾é¡µ
                initTabs();
                
                // åˆå§‹åŒ–è¯„è®º
                initComments();
                
                // åˆå§‹åŒ–åª’ä½“åˆ—è¡¨
                loadMediaList();
                
                // ç»‘å®šå›è½¦æäº¤
                [1,2,3,4,6,8,9,10,11,12,13,'free'].forEach(id => bindEnterSubmit(id));
                
                // ç»‘å®šåª’ä½“ä¸Šä¼ äº‹ä»¶
                bindMediaUploadEvents();
            } catch (err) {
                console.error('é¡µé¢åˆå§‹åŒ–å¤±è´¥ï¼š', err);
            }
        }
        // åˆå§‹åŒ–æ ‡ç­¾é¡µ
        function initTabs() {
            try {
                const tabs = document.querySelectorAll('.tab');
                tabs.forEach(tab => {
                    tab.addEventListener('click', () => {
                        tabs.forEach(t => t.classList.remove('active'));
                        tab.classList.add('active');
                        
                        const target = tab.getAttribute('data-target');
                        document.querySelectorAll('.tab-content').forEach(content => {
                            content.classList.remove('active');
                        });
                        
                        const targetContent = document.getElementById(target);
                        if (targetContent) targetContent.classList.add('active');
                    });
                });
            } catch (err) {
                console.error('æ ‡ç­¾é¡µåˆå§‹åŒ–å¤±è´¥ï¼š', err);
            }
        }
        // ç®¡ç†å‘˜ç™»å½•
        function adminLogin() {
            try {
                const pwdInput = document.getElementById('admin-pwd');
                if (!pwdInput) return;
                
                const pwd = pwdInput.value;
                if (pwd === ADMIN_PWD) {
                    isAdmin = true;
                    alert('ç®¡ç†å‘˜ç™»å½•æˆåŠŸï¼');
                    
                    const adminLoginEl = document.querySelector('.admin-login');
                    if (adminLoginEl) adminLoginEl.style.display = 'none';
                    
                    // é‡æ–°åˆå§‹åŒ–ä»¥æ˜¾ç¤ºåˆ é™¤æŒ‰é’®
                    initComments();
                    loadMediaList();
                } else {
                    alert('å¯†ç é”™è¯¯ï¼');
                    pwdInput.value = '';
                }
            } catch (err) {
                console.error('ç®¡ç†å‘˜ç™»å½•å¤±è´¥ï¼š', err);
            }
        }
        // ---------------------- è¯„è®ºç›¸å…³ ----------------------
        // ç¬¬å››æ­¥ï¼šä¿®æ”¹è¯„è®ºåŠ è½½å‡½æ•°
        async function initComments() {
            try {
                // å…ˆå°è¯•ä»Supabaseè·å–æ•°æ®
                const { data: supabaseComments, error } = await supabase
                    .from('comments')
                    .select('*')
                    .order('created_at', { ascending: true });

                if (!error && supabaseComments) {
                    // ä½¿ç”¨Supabaseæ•°æ®
                    const savedComments = {};
                    supabaseComments.forEach(comment => {
                        const topicId = comment.topic_id;
                        if (!savedComments[topicId]) {
                            savedComments[topicId] = [];
                        }
                        savedComments[topicId].push({
                            id: comment.id.toString(),
                            author: comment.author,
                            content: comment.content,
                            time: new Date(comment.created_at).getTime(),
                            like: comment.likes || 0,
                            isLiked: false,
                            level: 0,
                            replies: []
                        });
                    });
                    
                    // ä½¿ç”¨Supabaseæ•°æ®æ¸²æŸ“
                    renderAllComments(savedComments);
                    return;
                }
                
                // å¦‚æœSupabaseå¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°å­˜å‚¨
                console.log('ä½¿ç”¨æœ¬åœ°å­˜å‚¨æ•°æ®');
                const localComments = JSON.parse(localStorage.getItem(COMMENT_KEY) || '{}');
                renderAllComments(localComments);
                
            } catch (err) {
                console.error('åˆå§‹åŒ–è¯„è®ºå¤±è´¥ï¼š', err);
                // é™çº§åˆ°æœ¬åœ°å­˜å‚¨
                const localComments = JSON.parse(localStorage.getItem(COMMENT_KEY) || '{}');
                renderAllComments(localComments);
            }
        }
        
        // ç¬¬äº”æ­¥ï¼šæ·»åŠ æ¸²æŸ“æ‰€æœ‰è¯„è®ºçš„è¾…åŠ©å‡½æ•°
        function renderAllComments(savedComments) {
            const topicIds = [1,2,3,4,6,8,9,10,11,12,13,'free'];
            
            topicIds.forEach(topicId => {
                const listEl = document.getElementById(`comment-list-${topicId}`);
                if (!listEl) return;
                
                let comments = savedComments[topicId] || [];
                comments.sort((a,b) => (a.time || 0) - (b.time || 0));
                listEl.innerHTML = '';

                // åŸæœ‰çš„æ¸²æŸ“é€»è¾‘ä¿æŒä¸å˜
                const flatComments = [];
                comments.forEach(cmt => {
                    flatComments.push({...cmt, level: 0});
                    if (cmt.replies && cmt.replies.length > 0) {
                        flattenReplies(cmt.replies, flatComments, cmt.id, cmt.author);
                    }
                });

                // åˆ†ç»„æ¸²æŸ“é€»è¾‘ä¿æŒä¸å˜
                const commentGroups = [];
                while (flatComments.length > 0) {
                    commentGroups.push(flatComments.splice(0, 5));
                }

                commentGroups.forEach((group, groupIndex) => {
                    const groupDiv = document.createElement('div');
                    groupDiv.className = 'comment-group';
                    if (commentGroups.length > 1 && groupIndex > 0) {
                        const collapseBtn = document.createElement('button');
                        collapseBtn.className = 'collapse-btn';
                        collapseBtn.innerHTML = `â–¼ æ˜¾ç¤º ${group.length} æ¡è¯„è®º`;
                        collapseBtn.onclick = () => {
                            const contentDiv = groupDiv.querySelector('.group-content');
                            if (contentDiv) toggleCollapse(collapseBtn, contentDiv);
                        };
                        groupDiv.appendChild(collapseBtn);
                    }
                    const contentDiv = document.createElement('div');
                    contentDiv.className = 'group-content';
                    if (groupIndex > 0) contentDiv.style.display = 'none';
                    // æ¸²æŸ“æ¯æ¡è¯„è®º
                    group.forEach(cmt => {
                        const commentContainer = document.createElement('div');
                        commentContainer.className = `comment-container`;
                        
                        const cmtDiv = document.createElement('div');
                        // å¦‚æœæ˜¯å›å¤ï¼Œæ·»åŠ ç‰¹æ®Šæ ·å¼ç±»
                        cmtDiv.className = `comment ${cmt.parentId ? 'reply-comment' : ''}`;
                        cmtDiv.id = cmt.id;
                        cmtDiv.setAttribute('data-author', cmt.author);
                        cmtDiv.setAttribute('data-topic', topicId);
                        if (cmt.parentId) cmtDiv.setAttribute('data-parent', cmt.parentId);
                        
                        let contentHtml = '';
                        // å¦‚æœæ˜¯å›å¤ï¼Œæ˜¾ç¤ºå›å¤æ ‡è®°
                        if (cmt.parentId) {
                            const parentCmt = findCommentById(cmt.parentId, topicId);
                            if (parentCmt) {
                                contentHtml += `<span class="reply-to">å›å¤ @${parentCmt.author}ï¼š${parentCmt.content || ''}</span>`;
                            } else {
                                contentHtml += `<span class="reply-to">å›å¤ @å·²åˆ é™¤çš„è¯„è®º</span>`;
                            }
                        }
                        
                        contentHtml += `
                            <div class="comment-content">
                                <span class="comment-author">${cmt.author || 'åŒ¿åç”¨æˆ·'}ï¼š</span>
                                <span>${cmt.content || ''}</span>
                                <span class="comment-time">${formatTime(cmt.time || Date.now())}</span>
                            </div>
                            <div class="comment-actions">
                                <button class="action-btn like-btn ${cmt.isLiked ? 'active' : ''}" onclick="toggleLike(this)">ç‚¹èµ(${cmt.like || 0})</button>
                                <button class="action-btn reply-btn" onclick="showReplyInput('${cmt.id}', '${cmt.author || 'åŒ¿åç”¨æˆ·'}', ${typeof topicId === 'string' ? `'${topicId}'` : topicId})">å›å¤</button>
                                <button class="action-btn edit-btn" onclick="editComment('${cmt.id}', ${typeof topicId === 'string' ? `'${topicId}'` : topicId})">ç¼–è¾‘</button>
                                <button class="action-btn delete-btn" style="display:${isAdmin || (cmt.author === userName) ? 'inline-block' : 'none'}" onclick="deleteComment('${cmt.id}', ${typeof topicId === 'string' ? `'${topicId}'` : topicId})">åˆ é™¤</button>
                            </div>
                        `;
                        
                        cmtDiv.innerHTML = contentHtml;
                        commentContainer.appendChild(cmtDiv);
                        contentDiv.appendChild(commentContainer);
                    });
                    groupDiv.appendChild(contentDiv);
                    listEl.appendChild(groupDiv);
                });
            });
        }
        
        // æ ¼å¼åŒ–æ—¶é—´
        function formatTime(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diff = now - date;
            
            // å¦‚æœæ˜¯ä»Šå¤©å†…
            if (date.toDateString() === now.toDateString()) {
                if (diff < 60000) return 'åˆšåˆš';
                if (diff < 3600000) return `${Math.floor(diff/60000)}åˆ†é’Ÿå‰`;
                return `${Math.floor(diff/3600000)}å°æ—¶å‰`;
            }
            
            // å¦‚æœæ˜¯æ˜¨å¤©
            const yesterday = new Date(now);
            yesterday.setDate(yesterday.getDate() - 1);
            if (date.toDateString() === yesterday.toDateString()) {
                return `æ˜¨å¤© ${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
            }
            
            // å…¶ä»–æƒ…å†µ
            return date.toLocaleString();
        }
        // æ‰å¹³åŒ–å›å¤ - ä¿®æ”¹ä¸ºç‹¬ç«‹è¯„è®º
        function flattenReplies(replies, result, parentId, parentAuthor) {
            if (!replies || replies.length === 0) return;
            replies.forEach(reply => {
                // å°†å›å¤ä½œä¸ºç‹¬ç«‹è¯„è®ºæ·»åŠ åˆ°ç»“æœä¸­
                result.push({
                    ...reply,
                    parentId: parentId,
                    parentAuthor: parentAuthor
                });
                // é€’å½’å¤„ç†åµŒå¥—å›å¤
                if (reply.replies && reply.replies.length > 0) {
                    flattenReplies(reply.replies, result, reply.id, reply.author);
                }
            });
        }
        // æŠ˜å /å±•å¼€è¯„è®ºç»„
        function toggleCollapse(btn, contentDiv) {
            try {
                const isHidden = contentDiv.style.display === 'none';
                contentDiv.style.display = isHidden ? 'block' : 'none';
                btn.innerHTML = isHidden ? `â–² æ”¶èµ·è¯„è®º` : `â–¼ æ˜¾ç¤º ${contentDiv.querySelectorAll('.comment-container').length} æ¡è¯„è®º`;
            } catch (err) {
                console.error('æŠ˜å è¯„è®ºå¤±è´¥ï¼š', err);
            }
        }
        // æ˜¾ç¤ºå›å¤è¾“å…¥æ¡†
        function showReplyInput(parentId, parentAuthor, topicId) {
            try {
                // ç§»é™¤ç°æœ‰å›å¤æ¡†
                document.querySelectorAll('.reply-input-container').forEach(el => {
                    if (el.parentNode) el.parentNode.removeChild(el);
                });
                currentReplyId = parentId;
                
                const replyInput = createReplyInput(parentId, parentAuthor, topicId);
                const commentContainer = document.getElementById(parentId)?.closest('.comment-container');
                
                if (commentContainer) {
                    commentContainer.appendChild(replyInput);
                    const input = replyInput.querySelector('.reply-input');
                    if (input) input.focus();
                }
            } catch (err) {
                console.error('æ˜¾ç¤ºå›å¤æ¡†å¤±è´¥ï¼š', err);
            }
        }
        // åˆ›å»ºå›å¤è¾“å…¥æ¡†
        function createReplyInput(parentId, parentAuthor, topicId) {
            const container = document.createElement('div');
            container.className = 'reply-input-container';
            container.innerHTML = `
                <input type="text" class="reply-input" placeholder="å›å¤ @${parentAuthor}...">
                <button class="reply-submit" onclick="submitReply('${parentId}', ${typeof topicId === 'string' ? `'${topicId}'` : topicId})">å‘é€</button>
            `;
            
            const input = container.querySelector('.reply-input');
            if (input) {
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') submitReply(parentId, topicId);
                });
            }
            
            return container;
        }
        // æäº¤å›å¤ - ä¿®æ”¹ä¸ºç‹¬ç«‹è¯„è®º
        function submitReply(parentId, topicId) {
            try {
                const input = document.querySelector('.reply-input-container .reply-input');
                if (!input) return;
                
                const content = input.value.trim();
                if (!content) {
                    alert('è¯·è¾“å…¥å›å¤å†…å®¹ï¼');
                    return;
                }
                const savedComments = JSON.parse(localStorage.getItem(COMMENT_KEY) || '{}');
                if (!savedComments[topicId]) savedComments[topicId] = [];
                const parentCmt = findCommentById(parentId, topicId);
                
                // åˆ›å»ºå›å¤ä½œä¸ºç‹¬ç«‹è¯„è®º
                const replyData = {
                    id: `cmt-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
                    author: userName,
                    content: content,
                    time: Date.now(),
                    like: 0,
                    isLiked: false,
                    parentId: parentId, // æ ‡è®°è¿™æ˜¯å›å¤
                    parentAuthor: parentCmt ? parentCmt.author : 'æœªçŸ¥ç”¨æˆ·',
                    level: 0, // æ‰€æœ‰è¯„è®ºéƒ½æ˜¯é¡¶çº§
                    replies: [] // æ¸…ç©ºåµŒå¥—å›å¤
                };
                // ç›´æ¥æ·»åŠ åˆ°è¯„è®ºåˆ—è¡¨
                savedComments[topicId].push(replyData);
                savedComments[topicId].sort((a,b) => (a.time || 0) - (b.time || 0));
                localStorage.setItem(COMMENT_KEY, JSON.stringify(savedComments));
                initComments();
                currentReplyId = '';
            } catch (err) {
                console.error('æäº¤å›å¤å¤±è´¥ï¼š', err);
                alert('å›å¤å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }
        // æŸ¥æ‰¾è¯„è®º
        function findCommentById(commentId, topicId, comments = null) {
            try {
                const savedComments = comments || JSON.parse(localStorage.getItem(COMMENT_KEY) || '{}')[topicId] || [];
                for (const cmt of savedComments) {
                    if (cmt.id === commentId) return cmt;
                    if (cmt.replies && cmt.replies.length > 0) {
                        const found = findCommentById(commentId, topicId, cmt.replies);
                        if (found) return found;
                    }
                }
                return null;
            } catch (err) {
                console.error('æŸ¥æ‰¾è¯„è®ºå¤±è´¥ï¼š', err);
                return null;
            }
        }
        // ç¬¬ä¸‰æ­¥ï¼šä¿®æ”¹è¯„è®ºæäº¤å‡½æ•°
        async function submitComment(topicId, editId = '') {
            try {
                const input = document.getElementById(`comment-input-${topicId}`);
                if (!input) return;
                
                const content = input.value.trim();
                if (!content) {
                    alert('è¯·è¾“å…¥è¯„è®ºå†…å®¹ï¼');
                    return;
                }

                // æ’å…¥æ•°æ®åˆ°Supabase
                const { data, error } = await supabase
                    .from('comments')
                    .insert([
                        { 
                            topic_id: topicId.toString(),
                            author: userName,
                            content: content
                        }
                    ]);

                if (error) {
                    console.error('æäº¤è¯„è®ºå¤±è´¥ï¼š', error);
                    // é™çº§æ–¹æ¡ˆï¼šä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
                    saveToLocalStorage();
                    alert('ç½‘ç»œå¼‚å¸¸ï¼Œè¯„è®ºå·²ä¿å­˜åˆ°æœ¬åœ°');
                    return;
                }

                // æ¸…ç©ºè¾“å…¥æ¡†
                input.value = '';
                
                // é‡æ–°åŠ è½½è¯„è®º
                await initComments();
                
            } catch (err) {
                console.error('æäº¤è¯„è®ºå¼‚å¸¸ï¼š', err);
                // é™çº§æ–¹æ¡ˆ
                saveToLocalStorage();
                alert('æäº¤å¼‚å¸¸ï¼Œè¯„è®ºå·²ä¿å­˜åˆ°æœ¬åœ°');
            }
        }
        
        // æœ¬åœ°å­˜å‚¨ä¿å­˜è¾…åŠ©å‡½æ•°
        function saveToLocalStorage() {
            try {
                // è¿™é‡Œæ ¹æ®å®é™…éœ€è¦å®ç°æœ¬åœ°å­˜å‚¨ä¿å­˜é€»è¾‘
                console.log('ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨');
            } catch (err) {
                console.error('æœ¬åœ°å­˜å‚¨ä¿å­˜å¤±è´¥ï¼š', err);
            }
        }
        
        // æ›¿æ¢è¯„è®º
        function replaceCommentById(commentId, topicId, newComment, comments) {
            for (let i = 0; i < comments.length; i++) {
                if (comments[i].id === commentId) {
                    comments[i] = newComment;
                    return true;
                }
                if (comments[i].replies && comments[i].replies.length > 0) {
                    const replaced = replaceCommentById(commentId, topicId, newComment, comments[i].replies);
                    if (replaced) return true;
                }
            }
            return false;
        }
        // ç¼–è¾‘è¯„è®º
        function editComment(cmtId, topicId) {
            try {
                const cmt = findCommentById(cmtId, topicId);
                if (!cmt || (cmt.author !== userName && !isAdmin)) {
                    alert('æ— æƒé™ç¼–è¾‘ï¼');
                    return;
                }
                if (cmt.parentId) {
                    // ç¼–è¾‘å›å¤è¯„è®º
                    const parentAuthor = findCommentById(cmt.parentId, topicId)?.author || '';
                    showReplyInput(cmt.parentId, parentAuthor, topicId);
                    
                    const input = document.querySelector('.reply-input-container .reply-input');
                    if (input) input.value = cmt.content;
                    
                    const submitBtn = document.querySelector('.reply-submit');
                    if (submitBtn) {
                        submitBtn.onclick = () => submitEditReply(cmtId, cmt.parentId, topicId);
                    }
                } else {
                    // ç¼–è¾‘ä¸»è¯„è®º
                    const input = document.getElementById(`comment-input-${topicId}`);
                    if (input) {
                        input.value = cmt.content;
                        input.focus();
                        
                        const btn = document.querySelector(`.comment-input-container [data-topic="${topicId}"]`);
                        if (btn) {
                            btn.innerText = 'ä¿å­˜';
                            btn.onclick = () => submitComment(topicId, cmtId);
                        }
                    }
                }
            } catch (err) {
                console.error('ç¼–è¾‘è¯„è®ºå¤±è´¥ï¼š', err);
                alert('ç¼–è¾‘å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }
        // æäº¤ç¼–è¾‘å›å¤
        function submitEditReply(cmtId, parentId, topicId) {
            try {
                const input = document.querySelector('.reply-input-container .reply-input');
                if (!input) return;
                
                const content = input.value.trim();
                if (!content) {
                    alert('è¯·è¾“å…¥å›å¤å†…å®¹ï¼');
                    return;
                }
                const savedComments = JSON.parse(localStorage.getItem(COMMENT_KEY) || '{}');
                const cmt = findCommentById(cmtId, topicId);
                if (cmt) cmt.content = content;
                localStorage.setItem(COMMENT_KEY, JSON.stringify(savedComments));
                initComments();
                currentReplyId = '';
            } catch (err) {
                console.error('æäº¤ç¼–è¾‘å›å¤å¤±è´¥ï¼š', err);
                alert('ä¿®æ”¹å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }
        // åˆ é™¤è¯„è®º
        function deleteComment(cmtId, topicId) {
            try {
                if (!confirm('ç¡®å®šåˆ é™¤å—ï¼Ÿ')) return;
                
                const savedComments = JSON.parse(localStorage.getItem(COMMENT_KEY) || '{}');
                
                function removeCommentById(id, comments) {
                    for (let i = 0; i < comments.length; i++) {
                        if (comments[i].id === id) {
                            comments.splice(i, 1);
                            return true;
                        }
                        if (comments[i].replies && comments[i].replies.length > 0) {
                            const removed = removeCommentById(id, comments[i].replies);
                            if (removed) return true;
                        }
                    }
                    return false;
                }
                if (savedComments[topicId]) {
                    removeCommentById(cmtId, savedComments[topicId]);
                    localStorage.setItem(COMMENT_KEY, JSON.stringify(savedComments));
                    initComments();
                }
            } catch (err) {
                console.error('åˆ é™¤è¯„è®ºå¤±è´¥ï¼š', err);
                alert('åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }
        // ç‚¹èµåˆ‡æ¢
        function toggleLike(btn) {
            try {
                const cmtEl = btn.closest('.comment');
                if (!cmtEl) return;
                
                const cmtId = cmtEl.id;
                const topicId = cmtEl.getAttribute('data-topic');
                const cmt = findCommentById(cmtId, topicId);
                if (!cmt) return;
                cmt.isLiked = !cmt.isLiked;
                cmt.like = (cmt.like || 0) + (cmt.isLiked ? 1 : -1);
                if (cmt.like < 0) cmt.like = 0;
                
                const savedComments = JSON.parse(localStorage.getItem(COMMENT_KEY) || '{}');
                localStorage.setItem(COMMENT_KEY, JSON.stringify(savedComments));
                
                btn.classList.toggle('active');
                btn.innerText = `ç‚¹èµ(${cmt.like || 0})`;
            } catch (err) {
                console.error('ç‚¹èµå¤±è´¥ï¼š', err);
            }
        }
        // ç»‘å®šå›è½¦æäº¤
        function bindEnterSubmit(topicId) {
            try {
                const input = document.getElementById(`comment-input-${topicId}`);
                if (input) {
                    input.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter') submitComment(topicId);
                    });
                }
            } catch (err) {
                console.error('ç»‘å®šå›è½¦æäº¤å¤±è´¥ï¼š', err);
            }
        }
        // ---------------------- åª’ä½“ç›¸å…³ ----------------------
        // ç»‘å®šå›¾ç‰‡æ‹–åŠ¨ç¼©æ”¾äº‹ä»¶
        function bindImgDragZoomEvents() {
            try {
                const previewContent = document.getElementById('preview-content');
                if (!previewContent) return;
                
                // é¼ æ ‡æŒ‰ä¸‹
                previewContent.addEventListener('mousedown', (e) => {
                    const target = e.target;
                    if (target.classList.contains('preview-img')) {
                        isDragging = true;
                        startX = e.clientX;
                        startY = e.clientY;
                        const rect = target.getBoundingClientRect();
                        imgX = rect.left;
                        imgY = rect.top;
                        target.style.cursor = 'grabbing';
                        e.preventDefault();
                    }
                });
                
                // é¼ æ ‡ç§»åŠ¨
                document.addEventListener('mousemove', (e) => {
                    if (!isDragging) return;
                    
                    const previewImg = document.querySelector('.preview-img');
                    if (!previewImg) return;
                    
                    const dx = e.clientX - startX;
                    const dy = e.clientY - startY;
                    previewImg.style.position = 'relative';
                    previewImg.style.left = `${imgX + dx}px`;
                    previewImg.style.top = `${imgY + dy}px`;
                });
                
                // é¼ æ ‡æ¾å¼€
                document.addEventListener('mouseup', () => {
                    isDragging = false;
                    const previewImg = document.querySelector('.preview-img');
                    if (previewImg) previewImg.style.cursor = 'move';
                });
                
                // æ»šè½®ç¼©æ”¾
                previewContent.addEventListener('wheel', (e) => {
                    const previewImg = document.querySelector('.preview-img');
                    if (!previewImg) return;
                    
                    e.preventDefault();
                    const delta = e.deltaY > 0 ? -0.1 : 0.1;
                    zoomImg(delta);
                });
            } catch (err) {
                console.error('ç»‘å®šå›¾ç‰‡æ‹–åŠ¨ç¼©æ”¾äº‹ä»¶å¤±è´¥ï¼š', err);
            }
        }
        // å›¾ç‰‡ç¼©æ”¾
        function zoomImg(delta) {
            try {
                const previewImg = document.querySelector('.preview-img');
                if (!previewImg) return;
                
                imgScale += delta;
                imgScale = Math.max(0.5, Math.min(imgScale, 3));
                previewImg.style.transform = `scale(${imgScale})`;
            } catch (err) {
                console.error('å›¾ç‰‡ç¼©æ”¾å¤±è´¥ï¼š', err);
            }
        }
        // é‡ç½®å›¾ç‰‡ç¼©æ”¾å’Œä½ç½®
        function resetImgZoom() {
            try {
                const previewImg = document.querySelector('.preview-img');
                if (!previewImg) return;
                
                imgScale = 1;
                previewImg.style.transform = 'scale(1)';
                previewImg.style.left = '0';
                previewImg.style.top = '0';
            } catch (err) {
                console.error('é‡ç½®å›¾ç‰‡å¤±è´¥ï¼š', err);
            }
        }
        // ç»‘å®šåª’ä½“ä¸Šä¼ äº‹ä»¶
        function bindMediaUploadEvents() {
            try {
                const mediaContentInput = document.getElementById('media-content');
                if (mediaContentInput) {
                    mediaContentInput.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter') uploadMedia();
                    });
                }
                
                // ç»‘å®šå›¾ç‰‡æ‹–åŠ¨ç¼©æ”¾äº‹ä»¶
                bindImgDragZoomEvents();
            } catch (err) {
                console.error('ç»‘å®šåª’ä½“ä¸Šä¼ äº‹ä»¶å¤±è´¥ï¼š', err);
            }
        }
        // åŠ è½½åª’ä½“åˆ—è¡¨
        function loadMediaList() {
            try {
                const savedMedia = JSON.parse(localStorage.getItem(MEDIA_KEY) || '[]');
                savedMedia.sort((a,b) => (b.time || 0) - (a.time || 0)); // æŒ‰æ—¶é—´å€’åº
                
                const listEl = document.getElementById('media-list');
                if (!listEl) return;
                listEl.innerHTML = '';
                
                if (savedMedia.length === 0) {
                    listEl.innerHTML = '<p style="text-align:center;color:#666;width:100%;padding:20px;">æš‚æ— åª’ä½“å†…å®¹ï¼Œå¿«æ¥ä¸Šä¼ ç¬¬ä¸€å¼ ç…§ç‰‡æˆ–è§†é¢‘å§ï¼</p>';
                    return;
                }
                
                savedMedia.forEach(media => {
                    const mediaCard = document.createElement('div');
                    mediaCard.className = 'media-card';
                    mediaCard.id = media.id;
                    mediaCard.setAttribute('data-author', media.author);
                    mediaCard.setAttribute('data-type', media.type);
                    mediaCard.setAttribute('data-url', media.url);
                    mediaCard.setAttribute('data-content', media.content);
                    
                    let mediaHtml = '';
                    if (media.type === 'video') {
                        mediaHtml = `
                            <div class="media-container">
                                <video src="${media.url}" preload="metadata">æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè§†é¢‘æ’­æ”¾</video>
                                <div class="video-play-btn" onclick="toggleVideoPlay(this, event)">â–¶</div>
                            </div>
                        `;
                    } else {
                        mediaHtml = `
                            <div class="media-container">
                                <img src="${media.url}" alt="é«˜ä¸­å›å¿†" onerror="this.src='https://picsum.photos/seed/default/300/200'">
                            </div>
                        `;
                    }
                    
                    mediaCard.innerHTML = mediaHtml + `
                        <div class="media-info">
                            <span class="media-author">${media.author || 'åŒ¿åç”¨æˆ·'}ï¼š</span>
                            <span class="media-time">${formatTime(media.time || Date.now())}</span>
                            <div class="media-content">${media.content || ''}</div>
                            <div class="media-actions">
                                <button class="action-btn edit-btn" onclick="editMedia('${media.id}', event)">ç¼–è¾‘</button>
                                <button class="action-btn delete-btn" style="display:${isAdmin || (media.author === userName) ? 'inline-block' : 'none'}" onclick="deleteMedia('${media.id}', event)">åˆ é™¤</button>
                            </div>
                        </div>
                    `;
                    
                    // ç»‘å®šç‚¹å‡»æ”¾å¤§äº‹ä»¶
                    mediaCard.addEventListener('click', (e) => {
                        if (e.target.closest('.action-btn') || e.target.closest('.video-play-btn')) return;
                        openMediaPreview(media);
                    });
                    
                    listEl.appendChild(mediaCard);
                });
            } catch (err) {
                console.error('åŠ è½½åª’ä½“åˆ—è¡¨å¤±è´¥ï¼š', err);
            }
        }
        // æ‰“å¼€åª’ä½“é¢„è§ˆ
        function openMediaPreview(media) {
            try {
                currentPreviewMedia = media;
                const previewLayer = document.getElementById('media-preview');
                const previewContent = document.getElementById('preview-content');
                const zoomControls = document.getElementById('zoom-controls');
                
                if (!previewLayer || !previewContent) return;
                
                previewContent.innerHTML = '';
                imgScale = 1;
                
                if (media.type === 'video') {
                    zoomControls.style.display = 'none';
                    const video = document.createElement('video');
                    video.className = 'preview-video';
                    video.src = media.url;
                    video.controls = true;
                    previewContent.appendChild(video);
                } else {
                    zoomControls.style.display = 'flex';
                    const img = document.createElement('img');
                    img.className = 'preview-img';
                    img.src = media.url;
                    img.onerror = () => {
                        img.src = 'https://picsum.photos/seed/default/800/600';
                    };
                    img.style.transform = 'scale(1)';
                    img.style.cursor = 'move';
                    previewContent.appendChild(img);
                }
                
                previewLayer.style.display = 'flex';
            } catch (err) {
                console.error('æ‰“å¼€åª’ä½“é¢„è§ˆå¤±è´¥ï¼š', err);
                alert('é¢„è§ˆå¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }
        // å…³é—­åª’ä½“é¢„è§ˆ
        function closeMediaPreview() {
            try {
                const previewLayer = document.getElementById('media-preview');
                if (previewLayer) previewLayer.style.display = 'none';
                
                const video = document.querySelector('.preview-video');
                if (video) video.pause();
                
                currentPreviewMedia = null;
                resetImgZoom();
            } catch (err) {
                console.error('å…³é—­åª’ä½“é¢„è§ˆå¤±è´¥ï¼š', err);
            }
        }
        // ä¸‹è½½åª’ä½“
        function downloadMedia() {
            try {
                if (!currentPreviewMedia) return;
                
                const a = document.createElement('a');
                a.href = currentPreviewMedia.url;
                
                const ext = currentPreviewMedia.type === 'video' ? 'mp4' : 'jpg';
                const fileName = `${currentPreviewMedia.author || 'åŒ¿åç”¨æˆ·'}_${new Date(currentPreviewMedia.time || Date.now()).toLocaleDateString().replace(/\//g, '-')}.${ext}`;
                a.download = fileName;
                
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            } catch (err) {
                console.error('ä¸‹è½½åª’ä½“å¤±è´¥ï¼š', err);
                alert('ä¸‹è½½å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }
        // è§†é¢‘æ’­æ”¾/æš‚åœ
        function toggleVideoPlay(btn, event) {
            try {
                event.stopPropagation();
                const video = btn.closest('.media-container').querySelector('video');
                if (!video) return;
                
                if (video.paused) {
                    video.play().catch(err => {
                        console.error('è§†é¢‘æ’­æ”¾å¤±è´¥ï¼š', err);
                        alert('è§†é¢‘æ’­æ”¾å¤±è´¥ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨è®¾ç½®æˆ–ç½‘ç»œçŠ¶æ€');
                    });
                    btn.innerHTML = 'â¸';
                } else {
                    video.pause();
                    btn.innerHTML = 'â–¶';
                }
            } catch (err) {
                console.error('è§†é¢‘æ’­æ”¾æ§åˆ¶å¤±è´¥ï¼š', err);
            }
        }
        // ç¬¬å…­æ­¥ï¼šä¿®æ”¹åª’ä½“ä¸Šä¼ å‡½æ•°
        function uploadMedia() {
            try {
                const contentInput = document.getElementById('media-content');
                const fileInput = document.getElementById('media-file');
                const progressContainer = document.getElementById('progress-container');
                const progressBar = document.getElementById('upload-progress');
                
                if (!contentInput || !fileInput || !progressContainer || !progressBar) return;
                
                const content = contentInput.value.trim();
                const files = fileInput.files;
                
                if (!editMediaId && (!files || files.length === 0)) {
                    alert('è¯·é€‰æ‹©è¦ä¸Šä¼ çš„å›¾ç‰‡æˆ–è§†é¢‘ï¼');
                    return;
                }
                const savedMedia = JSON.parse(localStorage.getItem(MEDIA_KEY) || '[]');
                const existingMedia = editMediaId ? savedMedia.find(m=>m.id===editMediaId) : null;
                const mediaData = {
                    id: editMediaId || `media-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
                    author: userName,
                    content: content,
                    time: editMediaId ? (existingMedia?.time || Date.now()) : Date.now(),
                    url: editMediaId ? (existingMedia?.url || '') : '',
                    type: editMediaId ? (existingMedia?.type || 'image') : ''
                };
                // æ˜¾ç¤ºè¿›åº¦æ¡
                progressContainer.style.display = 'block';
                progressBar.style.width = '0%';
                if (files && files.length > 0) {
                    const file = files[0];
                    let fileType = '';
                    
                    if (file.type.startsWith('image/')) {
                        fileType = 'image';
                    } else if (file.type.startsWith('video/')) {
                        fileType = 'video';
                    } else {
                        alert('ä»…æ”¯æŒå›¾ç‰‡ï¼ˆJPG/PNGï¼‰å’Œè§†é¢‘ï¼ˆMP4/WEBMï¼‰æ ¼å¼ï¼');
                        progressContainer.style.display = 'none';
                        fileInput.value = '';
                        return;
                    }
                    // æ£€æŸ¥æ–‡ä»¶å¤§å° (10MBé™åˆ¶)
                    if (file.size > 10 * 1024 * 1024) {
                        alert('æ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡10MBï¼');
                        progressContainer.style.display = 'none';
                        fileInput.value = '';
                        return;
                    }
                    const reader = new FileReader();
                    
                    reader.onloadstart = function() {
                        progressBar.style.width = '10%';
                    };
                    
                    reader.onprogress = function(e) {
                        if (e.lengthComputable) {
                            const percent = (e.loaded / e.total) * 100;
                            progressBar.style.width = `${percent}%`;
                        }
                    };
                    
                    reader.onload = function(e) {
                        mediaData.url = e.target.result;
                        mediaData.type = fileType;
                        
                        // ä¿å­˜åˆ°Supabase
                        saveMediaToSupabase(mediaData);
                        
                        // åŒæ—¶ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨ï¼ˆé™çº§æ–¹æ¡ˆï¼‰
                        saveMediaData(mediaData, savedMedia);
                        
                        setTimeout(() => {
                            progressContainer.style.display = 'none';
                            progressBar.style.width = '0%';
                        }, 500);
                    };
                    
                    reader.onerror = function() {
                        alert('æ–‡ä»¶è¯»å–å¤±è´¥ï¼Œè¯·é‡è¯•ï¼');
                        progressContainer.style.display = 'none';
                        progressBar.style.width = '0%';
                        fileInput.value = '';
                    };
                    
                    reader.readAsDataURL(file);
                } else {
                    saveMediaData(mediaData, savedMedia);
                    progressContainer.style.display = 'none';
                }
            } catch (err) {
                console.error('ä¸Šä¼ åª’ä½“å¤±è´¥ï¼š', err);
                alert('ä¸Šä¼ å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }
        // ç¬¬ä¸ƒæ­¥ï¼šæ·»åŠ åª’ä½“ä¿å­˜åˆ°Supabaseçš„å‡½æ•°
        async function saveMediaToSupabase(mediaData) {
            try {
                const { data, error } = await supabase
                    .from('media')
                    .insert([
                        {
                            author: mediaData.author,
                            content: mediaData.content,
                            file_url: mediaData.url,
                            file_type: mediaData.type
                        }
                    ]);

                if (error) {
                    console.error('ä¿å­˜åª’ä½“åˆ°Supabaseå¤±è´¥ï¼š', error);
                    return false;
                }
                return true;
            } catch (err) {
                console.error('ä¿å­˜åª’ä½“å¼‚å¸¸ï¼š', err);
                return false;
            }
        }
        // ä¿å­˜åª’ä½“æ•°æ®
        function saveMediaData(mediaData, savedMedia) {
            try {
                if (editMediaId) {
                    const idx = savedMedia.findIndex(m=>m.id===editMediaId);
                    if (idx !== -1) savedMedia[idx] = mediaData;
                } else {
                    savedMedia.push(mediaData);
                }
                savedMedia.sort((a,b) => (b.time || 0) - (a
